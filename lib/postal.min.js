/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.8.11
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT, GPL
 */
(function(t,n){"object"==typeof module&&module.exports?module.exports=n(require("underscore"),this):"function"==typeof define&&define.amd?define(["underscore"],function(i){return n(i,t)}):t.postal=n(t._,t)})(this,function(t,n){var i,e=n.postal,r=function(t,n,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===n.length)throw new Error("Topics cannot be empty");this.channel=t,this.topic=n,this.subscribe(i)};r.prototype={unsubscribe:function(){this.inactive||(this.inactive=!0,i.unsubscribe(this))},subscribe:function(t){return this.callback=t,this.callback=new o({owner:this,prop:"callback",context:this,lazyInit:!0}),this},withContext:function(t){return this.callback.context(t),this}};var o=function(t){var n=t.owner[t.prop];if("function"!=typeof n)throw new Error("Strategies can only target methods.");var i=[],e=t.context||t.owner,r=function(){var t=0,r=function o(){var r,c=Array.prototype.slice.call(arguments,0),s=t;t+=1,s<i.length?(r=i[s],r.fn.apply(r.context||e,[o].concat(c))):n.apply(e,c)};r.apply(this,arguments)};return r.target=function(){return n},r.context=function(t){return 0===arguments.length?e:void(e=t)},r.strategies=function(){return i},r.useStrategy=function(t){for(var n=0,e=!1;n<i.length;){if(i[n].name===t.name){i[n]=t,e=!0;break}n+=1}e||i.push(t)},r.reset=function(){i=[]},t.lazyInit?(n.useStrategy=function(){t.owner[t.prop]=r,r.useStrategy.apply(r,arguments)},n.context=function(){return t.owner[t.prop]=r,r.context.apply(r,arguments)},n):r},c=function(){var n;return function(i){var e=!1;return t.isString(i)?(e=i===n,n=i):(e=t.isEqual(i,n),n=t.clone(i)),!e}},s=function(){var n=[];return function(i){var e=!t.any(n,function(n){return t.isObject(i)||t.isArray(i)?t.isEqual(i,n):i===n});return e&&n.push(i),e}},a={withDelay:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";return{name:"withDelay",fn:function(t,i,e){setTimeout(function(){t(i,e)},n)}}},defer:function(){return this.withDelay(0)},stopAfter:function(n,i){if(t.isNaN(n)||0>=n)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var e=t.after(n,i);return{name:"stopAfter",fn:function(t,n,i){e(),t(n,i)}}},withThrottle:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";return{name:"withThrottle",fn:t.throttle(function(t,n,i){t(n,i)},n)}},withDebounce:function(n,i){if(t.isNaN(n))throw"Milliseconds must be a number";return{name:"debounce",fn:t.debounce(function(t,n,i){t(n,i)},n,!!i)}},withConstraint:function(n){if(!t.isFunction(n))throw"Predicate constraint must be a function";return{name:"withConstraint",fn:function(t,i,e){n.call(this,i,e)&&t.call(this,i,e)}}},distinct:function(t){t=t||{};var n=function(t){return t[0]},i=t.all?new s(n):new c(n);return{name:"distinct",fn:function(t,n,e){i(n)&&t(n,e)}}}};r.prototype.defer=function(){return this.callback.useStrategy(a.defer()),this},r.prototype.disposeAfter=function(t){var n=this;return n.callback.useStrategy(a.stopAfter(t,function(){n.unsubscribe.call(n)})),n},r.prototype.distinctUntilChanged=function(){return this.callback.useStrategy(a.distinct()),this},r.prototype.distinct=function(){return this.callback.useStrategy(a.distinct({all:!0})),this},r.prototype.once=function(){return this.disposeAfter(1),this},r.prototype.withConstraint=function(t){return this.callback.useStrategy(a.withConstraint(t)),this},r.prototype.withDebounce=function(t,n){return this.callback.useStrategy(a.withDebounce(t,n)),this},r.prototype.withDelay=function(t){return this.callback.useStrategy(a.withDelay(t)),this},r.prototype.withThrottle=function(t){return this.callback.useStrategy(a.withThrottle(t)),this};var u=function(t){this.channel=t||i.configuration.DEFAULT_CHANNEL};u.prototype.subscribe=function(){return i.subscribe(1===arguments.length?new r(this.channel,arguments[0].topic,arguments[0].callback):new r(this.channel,arguments[0],arguments[1]))},u.prototype.publish=function(){var t=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};return t.channel=this.channel,i.publish(t)};var h={cache:{},regex:{},compare:function(n,i){var e,r,o,c=this.cache[i]&&this.cache[i][n];return"undefined"!=typeof c?c:((r=this.regex[n])||(e="^"+t.map(n.split("."),function(t){var n="";return o&&(n="#"!==o?"\\.\\b":"\\b"),n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,o=t,n}).join("")+"$",r=this.regex[n]=new RegExp(e)),this.cache[i]=this.cache[i]||{},this.cache[i][n]=c=r.test(i),c)},reset:function(){this.cache={},this.regex={}}},l=function(n,e){!n.inactive&&i.configuration.resolver.compare(n.topic,e.topic)&&t.all(n.constraints,function(t){return t.call(n.context,e.data,e)})&&"function"==typeof n.callback&&n.callback.call(n.context,e.data,e)},p=0,f=[],b=function(){for(;f.length;)i.unsubscribe(f.shift())};if(i={configuration:{resolver:h,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal"},subscriptions:{},wireTaps:[],ChannelDefinition:u,SubscriptionDefinition:r,channel:function(t){return new u(t)},subscribe:function(t){var n,i=new r(t.channel||this.configuration.DEFAULT_CHANNEL,t.topic,t.callback),e=this.subscriptions[i.channel];return this.publish({channel:this.configuration.SYSTEM_CHANNEL,topic:"subscription.created",data:{event:"subscription.created",channel:i.channel,topic:i.topic}}),e||(e=this.subscriptions[i.channel]={}),n=this.subscriptions[i.channel][i.topic],n||(n=this.subscriptions[i.channel][i.topic]=[]),n.push(i),i},publish:function(n){return++p,n.channel=n.channel||this.configuration.DEFAULT_CHANNEL,n.timeStamp=new Date,t.each(this.wireTaps,function(t){t(n.data,n)}),this.subscriptions[n.channel]&&t.each(this.subscriptions[n.channel],function(t){for(var i,e=0,r=t.length;r>e;)(i=t[e++])&&l(i,n)}),0===--p&&b(),n},unsubscribe:function(t){if(p)return void f.push(t);if(this.subscriptions[t.channel]&&this.subscriptions[t.channel][t.topic])for(var n=this.subscriptions[t.channel][t.topic].length,i=0;n>i;){if(this.subscriptions[t.channel][t.topic][i]===t){this.subscriptions[t.channel][t.topic].splice(i,1);break}i+=1}this.publish({channel:this.configuration.SYSTEM_CHANNEL,topic:"subscription.removed",data:{event:"subscription.removed",channel:t.channel,topic:t.topic}})},addWireTap:function(t){var n=this;return n.wireTaps.push(t),function(){var i=n.wireTaps.indexOf(t);-1!==i&&n.wireTaps.splice(i,1)}},linkChannels:function(n,i){var e=[],r=this;return n=t.isArray(n)?n:[n],i=t.isArray(i)?i:[i],t.each(n,function(n){var o=n.topic||"#";t.each(i,function(i){var c=i.channel||r.configuration.DEFAULT_CHANNEL;e.push(r.subscribe({channel:n.channel||r.configuration.DEFAULT_CHANNEL,topic:o,callback:function(n,e){var o=t.clone(e);o.topic=t.isFunction(i.topic)?i.topic(e.topic):i.topic||e.topic,o.channel=c,o.data=n,r.publish(o)}}))})}),e},noConflict:function(){if("undefined"==typeof window)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return n.postal=e,this},getSubscribersFor:function(){var t=arguments[0],n=arguments[1];return 1===arguments.length&&(t=arguments[0].channel||this.configuration.DEFAULT_CHANNEL,n=arguments[0].topic),this.subscriptions[t]&&Object.prototype.hasOwnProperty.call(this.subscriptions[t],n)?this.subscriptions[t][n]:[]},reset:function(){this.subscriptions&&(t.each(this.subscriptions,function(n){t.each(n,function(t){for(;t.length;)t.pop().unsubscribe()})}),this.subscriptions={}),this.configuration.resolver.reset()}},i.subscriptions[i.configuration.SYSTEM_CHANNEL]={},n&&Object.prototype.hasOwnProperty.call(n,"__postalReady__")&&t.isArray(n.__postalReady__))for(;n.__postalReady__.length;)n.__postalReady__.shift().onReady(i);return i});