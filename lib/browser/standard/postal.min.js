(function(a,b){var c="/",d=50,e=0,f="postal",g=function(){},h=function(){var a;return function(b){var c=!1;return _.isString(b)?(c=b===a,a=b):(c=_.isEqual(b,a),a=_.clone(b)),!c}},i=function(a,b){this.exchange=a,this.topic=b};i.prototype={subscribe:function(a){return n.configuration.bus.subscribe(new j(this.exchange,this.topic,a))},publish:function(a,b){var c=b||{};c.exchange=this.exchange,c.timeStamp=new Date,c.topic=this.topic,n.configuration.bus.publish(c,a)}};var j=function(a,b,c){this.exchange=a,this.topic=b,this.callback=c,this.priority=d,this.constraints=new Array(0),this.maxCalls=e,this.onHandled=g,this.context=null,n.publish({exchange:f,topic:"subscription.created"},{event:"subscription.created",exchange:a,topic:b})};j.prototype={unsubscribe:function(){n.configuration.bus.unsubscribe(this),n.publish({exchange:f,topic:"subscription.removed"},{event:"subscription.removed",exchange:this.exchange,topic:this.topic})},defer:function(){var a=this.callback;return this.callback=function(b){setTimeout(a,0,b)},this},disposeAfter:function(a){if(_.isNaN(a)||a<=0)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var b=this.onHandled,c=_.after(a,_.bind(function(){this.unsubscribe(this)},this));return this.onHandled=function(){b.apply(this.context,arguments),c()},this},ignoreDuplicates:function(){return this.withConstraint(new h),this},whenHandledThenExecute:function(a){if(!_.isFunction(a))throw"Value provided to 'whenHandledThenExecute' must be a function";return this.onHandled=a,this},withConstraint:function(a){if(!_.isFunction(a))throw"Predicate constraint must be a function";return this.constraints.push(a),this},withConstraints:function(a){var b=this;return _.isArray(a)&&_.each(a,function(a){b.withConstraint(a)}),b},withContext:function(a){return this.context=a,this},withDebounce:function(a){if(_.isNaN(a))throw"Milliseconds must be a number";var b=this.callback;return this.callback=_.debounce(b,a),this},withDelay:function(a){if(_.isNaN(a))throw"Milliseconds must be a number";var b=this.callback;return this.callback=function(c){setTimeout(b,a,c)},this},withPriority:function(a){if(_.isNaN(a))throw"Priority must be a number";return this.priority=a,this},withThrottle:function(a){if(_.isNaN(a))throw"Milliseconds must be a number";var b=this.callback;return this.callback=_.throttle(b,a),this}};var k={cache:{},compare:function(a,b){if(this.cache[b]&&this.cache[b][a])return!0;var c=new RegExp("^"+a.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/#/g,"[A-Z,a-z,0-9]*")+"$"),d=c.test(b);return d&&(this.cache[b]||(this.cache[b]={}),this.cache[b][a]=!0),d}},l={subscriptions:{},wireTaps:new Array(0),publish:function(a,b){_.each(this.wireTaps,function(c){c(a,b)}),_.each(this.subscriptions[a.exchange],function(c){_.each(c,function(c){n.configuration.resolver.compare(c.topic,a.topic)&&_.all(c.constraints,function(a){return a(b)})&&typeof c.callback=="function"&&(c.callback.apply(c.context,[b,a]),c.onHandled())})})},subscribe:function(a){var b,c,d,e=this.subscriptions[a.exchange],f;e||(e=this.subscriptions[a.exchange]={}),f=this.subscriptions[a.exchange][a.topic],f||(f=this.subscriptions[a.exchange][a.topic]=new Array(0)),b=f.length-1;for(;b>=0;b--)if(f[b].priority<=a.priority){f.splice(b+1,0,a),c=!0;break}return c||f.unshift(a),a},unsubscribe:function(a){if(this.subscriptions[a.exchange][a.topic]){var b=this.subscriptions[a.exchange][a.topic].length,c=0;for(;c<b;c++)if(this.subscriptions[a.exchange][a.topic][c]===a){this.subscriptions[a.exchange][a.topic].splice(c,1);break}}},addWireTap:function(a){var b=this;return b.wireTaps.push(a),function(){var c=b.wireTaps.indexOf(a);c!==-1&&b.wireTaps.splice(c,1)}}},m={2:function(a,b){a.exchange||(a.exchange=c),n.configuration.bus.publish(a,b)},3:function(a,b,c){n.configuration.bus.publish({exchange:a,topic:b},c)}},n={configuration:{bus:l,resolver:k},channel:function(a){var b=a.exchange||c,d=a.topic;return new i(b,d)},subscribe:function(a){var b=a.callback,d=a.topic,e=a.exchange||c;return new j(e,d,b)},publish:function(){var a=arguments.length;m[a]&&m[a].apply(this,arguments)},addWireTap:function(a){return this.configuration.bus.addWireTap(a)},bindExchanges:function(a,b){var d;return _.isArray(a)||(a=[a]),_.isArray(b)||(b=[b]),d=new Array(a.length*b.length),_.each(a,function(a){var e=a.topic||"*";_.each(b,function(b){var e=b.exchange||c;d.push(n.subscribe({exchange:a.exchange||c,topic:a.topic||"*",callback:function(a,c){var d=c;d.topic=_.isFunction(b.topic)?b.topic(c.topic):b.topic||c.topic,d.exchange=e,n.publish(d,a)}}))})}),d}};a.postal=n})(window)