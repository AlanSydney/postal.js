var _=require("underscore"),DEFAULT_CHANNEL="/",DEFAULT_PRIORITY=50,DEFAULT_DISPOSEAFTER=0,SYSTEM_CHANNEL="postal",NO_OP=function(){},DistinctPredicate=function(){var a;return function(b){var c=!1;return _.isString(b)?(c=b===a,a=b):(c=_.isEqual(b,a),a=_.clone(b)),!c}},ChannelDefinition=function(a,b){this.channel=a||DEFAULT_CHANNEL,this._topic=b||""};ChannelDefinition.prototype={subscribe:function(){var a=arguments.length;if(a===1)return new SubscriptionDefinition(this.channel,this._topic,arguments[0]);if(a===2)return new SubscriptionDefinition(this.channel,arguments[0],arguments[1])},publish:function(a){var b=a||{},c={channel:this.channel,topic:this._topic,data:b};return b.topic&&b.data&&(c=b,c.channel=c.channel||this.channel),c.timeStamp=new Date,postal.configuration.bus.publish(c),c},topic:function(a){return a===this._topic?this:new ChannelDefinition(this.channel,a)}};var SubscriptionDefinition=function(a,b,c){this.channel=a,this.topic=b,this.callback=c,this.priority=DEFAULT_PRIORITY,this.constraints=new Array(0),this.maxCalls=DEFAULT_DISPOSEAFTER,this.onHandled=NO_OP,this.context=null,postal.configuration.bus.publish({channel:SYSTEM_CHANNEL,topic:"subscription.created",timeStamp:new Date,data:{event:"subscription.created",channel:a,topic:b}}),postal.configuration.bus.subscribe(this)};SubscriptionDefinition.prototype={unsubscribe:function(){postal.configuration.bus.unsubscribe(this),postal.configuration.bus.publish({channel:SYSTEM_CHANNEL,topic:"subscription.removed",timeStamp:new Date,data:{event:"subscription.removed",channel:this.channel,topic:this.topic}})},defer:function(){var a=this.callback;return this.callback=function(b){setTimeout(a,0,b)},this},disposeAfter:function(a){if(_.isNaN(a)||a<=0)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var b=this.onHandled,c=_.after(a,_.bind(function(){this.unsubscribe(this)},this));return this.onHandled=function(){b.apply(this.context,arguments),c()},this},ignoreDuplicates:function(){return this.withConstraint(new DistinctPredicate),this},withConstraint:function(a){if(!_.isFunction(a))throw"Predicate constraint must be a function";return this.constraints.push(a),this},withConstraints:function(a){var b=this;return _.isArray(a)&&_.each(a,function(a){b.withConstraint(a)}),b},withContext:function(a){return this.context=a,this},withDebounce:function(a){if(_.isNaN(a))throw"Milliseconds must be a number";var b=this.callback;return this.callback=_.debounce(b,a),this},withDelay:function(a){if(_.isNaN(a))throw"Milliseconds must be a number";var b=this.callback;return this.callback=function(c){setTimeout(function(){b(c)},a)},this},withPriority:function(a){if(_.isNaN(a))throw"Priority must be a number";return this.priority=a,this},withThrottle:function(a){if(_.isNaN(a))throw"Milliseconds must be a number";var b=this.callback;return this.callback=_.throttle(b,a),this},subscribe:function(a){return this.callback=a,this}};var bindingsResolver={cache:{},compare:function(a,b){if(this.cache[b]&&this.cache[b][a])return!0;var c=new RegExp("^"+a.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/#/g,"[A-Z,a-z,0-9]*")+"$"),d=c.test(b);return d&&(this.cache[b]||(this.cache[b]={}),this.cache[b][a]=!0),d},reset:function(){this.cache={}}},localBus={addWireTap:function(a){var b=this;return b.wireTaps.push(a),function(){var c=b.wireTaps.indexOf(a);c!==-1&&b.wireTaps.splice(c,1)}},publish:function(a){_.each(this.wireTaps,function(b){b(a.data,a)}),_.each(this.subscriptions[a.channel],function(b){_.each(b,function(b){postal.configuration.resolver.compare(b.topic,a.topic)&&_.all(b.constraints,function(b){return b(a.data,a)})&&typeof b.callback=="function"&&(b.callback.apply(b.context,[a.data,a]),b.onHandled())})})},reset:function(){this.subscriptions&&(_.each(this.subscriptions,function(a){_.each(a,function(a){while(a.length)a.pop().unsubscribe()})}),this.subscriptions={})},subscribe:function(a){var b,c,d,e=this.subscriptions[a.channel],f;e||(e=this.subscriptions[a.channel]={}),f=this.subscriptions[a.channel][a.topic],f||(f=this.subscriptions[a.channel][a.topic]=new Array(0)),b=f.length-1;for(;b>=0;b--)if(f[b].priority<=a.priority){f.splice(b+1,0,a),c=!0;break}return c||f.unshift(a),a},subscriptions:{},wireTaps:new Array(0),unsubscribe:function(a){if(this.subscriptions[a.channel][a.topic]){var b=this.subscriptions[a.channel][a.topic].length,c=0;for(;c<b;c++)if(this.subscriptions[a.channel][a.topic][c]===a){this.subscriptions[a.channel][a.topic].splice(c,1);break}}}},publishPicker={1:function(a){if(!a)throw new Error("publishing from the 'global' postal.publish call requires a valid envelope.");return a.channel=a.channel||DEFAULT_CHANNEL,a.timeStamp=new Date,postal.configuration.bus.publish(a),a},2:function(a,b){var c={channel:DEFAULT_CHANNEL,topic:a,timeStamp:new Date,data:b};return postal.configuration.bus.publish(c),c},3:function(a,b,c){var d={channel:a,topic:b,timeStamp:new Date,data:c};return postal.configuration.bus.publish(d),d}},channelPicker={1:function(a){var b=a,c,d={};return Object.prototype.toString.call(b)==="[object String]"?(b=DEFAULT_CHANNEL,c=a):(b=a.channel||DEFAULT_CHANNEL,c=a.topic,d=a.options||d),new postal.channelTypes[d.type||"local"](b,c)},2:function(a,b){var c=a,d=b,e={};return Object.prototype.toString.call(b)==="[object Object]"&&(c=DEFAULT_CHANNEL,d=a,e=b),new postal.channelTypes[e.type||"local"](c,d)},3:function(a,b,c){return new postal.channelTypes[c.type||"local"](a,b)}},sessionInfo={};localBus.subscriptions[SYSTEM_CHANNEL]={};var postal={configuration:{bus:localBus,resolver:bindingsResolver,DEFAULT_CHANNEL:DEFAULT_CHANNEL,DEFAULT_PRIORITY:DEFAULT_PRIORITY,DEFAULT_DISPOSEAFTER:DEFAULT_DISPOSEAFTER,SYSTEM_CHANNEL:SYSTEM_CHANNEL},channelTypes:{local:ChannelDefinition},channel:function(){var a=arguments.length;if(channelPicker[a])return channelPicker[a].apply(this,arguments)},subscribe:function(a){var b=a.callback,c=a.topic,d=a.channel||DEFAULT_CHANNEL;return new SubscriptionDefinition(d,c,b)},publish:function(){var a=arguments.length;if(publishPicker[a])return publishPicker[a].apply(this,arguments)},addWireTap:function(a){return this.configuration.bus.addWireTap(a)},linkChannels:function(a,b){var c=[];return _.isArray(a)||(a=[a]),_.isArray(b)||(b=[b]),_.each(a,function(a){var d=a.topic||"*";_.each(b,function(b){var d=b.channel||DEFAULT_CHANNEL;c.push(postal.subscribe({channel:a.channel||DEFAULT_CHANNEL,topic:a.topic||"*",callback:function(a,c){var e=c;e.topic=_.isFunction(b.topic)?b.topic(c.topic):b.topic||c.topic,e.channel=d,e.data=a,postal.publish(e)}}))})}),c},utils:{getSubscribersFor:function(){var a=arguments[0],b=arguments[1],c=[];return arguments.length===1&&(Object.prototype.toString.call(a)==="[object String]"?(a=postal.configuration.DEFAULT_CHANNEL,b=arguments[0]):(a=arguments[0].channel||postal.configuration.DEFAULT_CHANNEL,b=arguments[0].topic)),postal.configuration.bus.subscriptions[a]&&postal.configuration.bus.subscriptions[a].hasOwnProperty(b)&&(c=postal.configuration.bus.subscriptions[a][b]),c},reset:function(){postal.configuration.bus.reset(),postal.configuration.resolver.reset()}}};module.exports=postal