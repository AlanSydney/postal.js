/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.8.11
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT, GPL
 */
(function(n,t){"object"==typeof module&&module.exports?module.exports=t(require("underscore"),this):"function"==typeof define&&define.amd?define(["underscore"],function(i){return t(i,n)}):n.postal=t(n._,n)})(this,function(n,t){var i,e=t.postal,c=function(n){var t=n.owner[n.prop];if("function"!=typeof t)throw new Error("Strategies can only target methods.");var i=[],e=n.context||n.owner,c=function(){var n=0,c=function r(){var c,s=Array.prototype.slice.call(arguments,0),o=n;n+=1,o<i.length?(c=i[o],c.fn.apply(c.context||e,[r].concat(s))):t.apply(e,s)};c.apply(this,arguments)};return c.target=function(){return t},c.context=function(n){return 0===arguments.length?e:void(e=n)},c.strategies=function(){return i},c.useStrategy=function(n){for(var t=0,e=!1;t<i.length;){if(i[t].name===n.name){i[t]=n,e=!0;break}t+=1}e||i.push(n)},c.reset=function(){i=[]},n.lazyInit?(t.useStrategy=function(){n.owner[n.prop]=c,c.useStrategy.apply(c,arguments)},t.context=function(){return n.owner[n.prop]=c,c.context.apply(c,arguments)},t):c},r=function(n){this.channel=n||i.configuration.DEFAULT_CHANNEL};r.prototype.subscribe=function(){return i.subscribe(1===arguments.length?new s(this.channel,arguments[0].topic,arguments[0].callback):new s(this.channel,arguments[0],arguments[1]))},r.prototype.publish=function(){var n=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};return n.channel=this.channel,i.publish(n)};var s=function(n,t,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===t.length)throw new Error("Topics cannot be empty");this.channel=n,this.topic=t,this.subscribe(i)};s.prototype={unsubscribe:function(){this.inactive||(this.inactive=!0,i.unsubscribe(this))},subscribe:function(n){return this.callback=n,this.callback=new c({owner:this,prop:"callback",context:this,lazyInit:!0}),this},withContext:function(n){return this.callback.context(n),this}};var o={cache:{},regex:{},compare:function(t,i){var e,c,r,s=this.cache[i]&&this.cache[i][t];return"undefined"!=typeof s?s:((c=this.regex[t])||(e="^"+n.map(t.split("."),function(n){var t="";return r&&(t="#"!==r?"\\.\\b":"\\b"),t+="#"===n?"[\\s\\S]*":"*"===n?"[^.]+":n,r=n,t}).join("")+"$",c=this.regex[t]=new RegExp(e)),this.cache[i]=this.cache[i]||{},this.cache[i][t]=s=c.test(i),s)},reset:function(){this.cache={},this.regex={}}},a=function(t,e){!t.inactive&&i.configuration.resolver.compare(t.topic,e.topic)&&n.all(t.constraints,function(n){return n.call(t.context,e.data,e)})&&"function"==typeof t.callback&&t.callback.call(t.context,e.data,e)},u=0,h=[],p=function(){for(;h.length;)i.unsubscribe(h.shift())};if(i={configuration:{resolver:o,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal"},subscriptions:{},wireTaps:[],ChannelDefinition:r,SubscriptionDefinition:s,channel:function(n){return new r(n)},subscribe:function(n){var t,i=new s(n.channel||this.configuration.DEFAULT_CHANNEL,n.topic,n.callback),e=this.subscriptions[i.channel];return this.publish({channel:this.configuration.SYSTEM_CHANNEL,topic:"subscription.created",data:{event:"subscription.created",channel:i.channel,topic:i.topic}}),e||(e=this.subscriptions[i.channel]={}),t=this.subscriptions[i.channel][i.topic],t||(t=this.subscriptions[i.channel][i.topic]=[]),t.push(i),i},publish:function(t){return++u,t.channel=t.channel||this.configuration.DEFAULT_CHANNEL,t.timeStamp=new Date,n.each(this.wireTaps,function(n){n(t.data,t)}),this.subscriptions[t.channel]&&n.each(this.subscriptions[t.channel],function(n){for(var i,e=0,c=n.length;c>e;)(i=n[e++])&&a(i,t)}),0===--u&&p(),t},unsubscribe:function(n){if(u)return void h.push(n);if(this.subscriptions[n.channel]&&this.subscriptions[n.channel][n.topic])for(var t=this.subscriptions[n.channel][n.topic].length,i=0;t>i;){if(this.subscriptions[n.channel][n.topic][i]===n){this.subscriptions[n.channel][n.topic].splice(i,1);break}i+=1}this.publish({channel:this.configuration.SYSTEM_CHANNEL,topic:"subscription.removed",data:{event:"subscription.removed",channel:n.channel,topic:n.topic}})},addWireTap:function(n){var t=this;return t.wireTaps.push(n),function(){var i=t.wireTaps.indexOf(n);-1!==i&&t.wireTaps.splice(i,1)}},linkChannels:function(t,i){var e=[],c=this;return t=n.isArray(t)?t:[t],i=n.isArray(i)?i:[i],n.each(t,function(t){var r=t.topic||"#";n.each(i,function(i){var s=i.channel||c.configuration.DEFAULT_CHANNEL;e.push(c.subscribe({channel:t.channel||c.configuration.DEFAULT_CHANNEL,topic:r,callback:function(t,e){var r=n.clone(e);r.topic=n.isFunction(i.topic)?i.topic(e.topic):i.topic||e.topic,r.channel=s,r.data=t,c.publish(r)}}))})}),e},noConflict:function(){if("undefined"==typeof window)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return t.postal=e,this},getSubscribersFor:function(){var n=arguments[0],t=arguments[1];return 1===arguments.length&&(n=arguments[0].channel||this.configuration.DEFAULT_CHANNEL,t=arguments[0].topic),this.subscriptions[n]&&Object.prototype.hasOwnProperty.call(this.subscriptions[n],t)?this.subscriptions[n][t]:[]},reset:function(){this.subscriptions&&(n.each(this.subscriptions,function(t){n.each(t,function(n){for(;n.length;)n.pop().unsubscribe()})}),this.subscriptions={}),this.configuration.resolver.reset()}},i.subscriptions[i.configuration.SYSTEM_CHANNEL]={},t&&Object.prototype.hasOwnProperty.call(t,"__postalReady__")&&n.isArray(t.__postalReady__))for(;t.__postalReady__.length;)t.__postalReady__.shift().onReady(i);return i});